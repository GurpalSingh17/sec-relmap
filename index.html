<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Relationship Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<style>
:root{
  --bg:#FAF9F7;--card:#FFF;--ink:#2D2D2C;--muted:#6B6F72;--line:#E5E1DC;
  --accent:#D04A02;--parent:#D04A02;--child:#00A3A1;--link:#C8C4BE;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
h1{margin:0 0 6px;font-size:20px}
.small{color:var(--muted);font-size:13px}
header{padding:16px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));backdrop-filter:blur(6px);z-index:3}
.row{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;align-items:center}
button,.pill{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer}
button:hover{border-color:var(--accent)}
input[type="file"]{display:none}
label[for="file"]{padding:8px 12px;border-radius:10px;border:1px dashed var(--line);background:#fff;cursor:pointer}
#drop{border:1px dashed var(--line);border-radius:12px;background:#fff;padding:8px 12px}
.help{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer}
.tab.active{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent)}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
input[type="search"]{flex:1;min-width:260px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink)}
select{padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink)}
.view{display:none}.view.active{display:block}
.section{padding:18px}
.card{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:8px 12px;margin-bottom:12px}
summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:10px}
summary::-webkit-details-marker{display:none}
.parent-name{font-weight:600}
.badge{background:color-mix(in srgb, var(--accent) 12%, white);color:var(--accent);padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid color-mix(in srgb, var(--accent) 30%, white)}
.inner{padding:10px 4px 14px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid var(--line);padding:8px 6px;vertical-align:top}
th{text-align:left;color:#474B4E;position:sticky;top:118px;background:var(--card)}
td.src a{color:#0B6DAA;text-decoration:none}
.hidden{display:none !important}
footer{padding:12px 18px;color:var(--muted);border-top:1px solid var(--line)}
#graph-wrap{height:calc(100vh - 320px);position:relative;border-top:1px solid var(--line);margin-top:8px}
#graph{width:100%;height:100%;background:#FFF}
.legend{position:absolute;left:12px;top:12px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:12px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
.legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
.dot.parent{background:var(--parent)}.dot.child{background:var(--child)}
.tooltip{position:absolute;background:#fff;color:var(--ink);font-size:12px;border:1px solid var(--line);border-radius:8px;padding:8px 10px;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap;display:none;z-index:5;box-shadow:0 8px 18px rgba(0,0,0,.08)}
.pill strong{margin-right:6px}
.hist{display:flex;align-items:center;gap:8px}
#hist{width:260px;height:48px;border:1px solid var(--line);border-radius:8px;background:#fff}
.color-key{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.key-item{display:flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
.key-box{width:12px;height:12px;border-radius:3px}
</style>
</head>
<body>
<header>
  <h1>Relationship Map</h1>
  <div class="small">Parents (active): <span id="stat-parents">0</span> · Links (active): <span id="stat-links">0</span></div>

  <div class="row">
    <label for="file">Choose CSV</label><input id="file" type="file" accept=".csv,text/csv"/>
    <div id="drop">…or drop CSV here</div>
    <span class="help">Needs <code>Parent Entity Name</code>, <code>Child Entity</code> (or <code>Issuer Name</code>), <code>Filing Date</code>. <em>Jurisdiction</em> optional.</span>
  </div>

  <div class="tabs">
    <button id="btn-list"  class="tab"      >List view</button>
    <button id="btn-graph" class="tab active">Graph view</button>
  </div>

  <!-- LIST controls -->
  <div class="controls" id="list-controls" style="display:none">
    <input id="q" type="search" placeholder="Search parent name…"/>
    <button id="expand">Expand all</button>
    <button id="collapse">Collapse all</button>
  </div>

  <!-- GRAPH controls -->
  <div id="graph-controls" class="controls">
    <span class="pill"><strong>Mode</strong></span>
    <button id="mode-overview" class="pill">Overview</button>
    <button id="mode-focus" class="pill">Focus parent</button>
    <button id="mode-network" class="pill">Network</button>

    <label class="pill">Top parents
      <select id="net-count"><option>20</option><option selected>50</option><option>100</option><option>200</option></select>
    </label>

    <label class="pill">Layout
      <select id="net-layout">
        <option value="circle" selected>Circle</option>
        <option value="grid">Grid</option>
        <option value="radial">Radial (by size)</option>
      </select>
    </label>

    <label class="pill">Spacing
      <input id="net-spacing" type="range" min="0.8" max="3.0" step="0.1" value="1.6">
    </label>

    <label class="pill">Parent size (max)
      <input id="parent-size" type="range" min="12" max="48" step="1" value="28">
    </label>

    <label class="pill">Min degree
      <input id="min-degree" type="range" min="0" max="10" step="1" value="0">
    </label>

    <label class="pill">Max labels
      <input id="max-labels" type="range" min="0" max="300" step="10" value="120">
    </label>

    <label class="pill">Color children by
      <select id="color-by">
        <option value="jurisdiction">Jurisdiction</option>
        <option value="single" selected>Single color</option>
      </select>
    </label>

    <select id="parent-select" title="Choose parent (Focus mode)"></select>
    <button id="rerun">Re-run layout</button>
    <button id="fit">Fit</button>
    <button id="export">Export PNG</button>
  </div>

  <!-- TIME FILTER -->
  <div id="time-controls" class="controls">
    <span class="pill"><strong>Time</strong></span>
    <div class="hist">
      <canvas id="hist"></canvas>
      <button id="play">Play</button>
    </div>
    <label class="pill">From
      <input id="year-from" type="range" min="2000" max="2030" step="1" value="2000">
    </label>
    <label class="pill">To
      <input id="year-to" type="range" min="2000" max="2030" step="1" value="2030">
    </label>
    <div class="pill">Range: <span id="yr-range"></span></div>
    <label class="pill"><input id="time-on" type="checkbox"> Apply time filter</label>
    <div class="color-key" id="jur-key"></div>
  </div>
</header>

<main>
  <section id="view-list" class="view section"><div class="help">Load a CSV to see grouped results.</div></section>
  <section id="view-graph" class="view active section">
    <div id="graph-wrap">
      <canvas id="graph"></canvas>
      <div class="legend"><span class="dot parent"></span>Parent · <span class="dot child"></span>Child</div>
      <div id="tip" class="tooltip"></div>
    </div>
  </section>
</main>

<footer>Generated <span id="gen-ts"></span></footer>

<script>
document.getElementById('gen-ts').textContent = new Date().toISOString().slice(0,19).replace('T',' ');

/* ---------- simple tab switching (explicit IDs) ---------- */
const btnList = document.getElementById('btn-list');
const btnGraph= document.getElementById('btn-graph');
function showList(){ btnList.classList.add('active'); btnGraph.classList.remove('active');
  document.getElementById('view-list').classList.add('active');
  document.getElementById('view-graph').classList.remove('active');
  document.getElementById('list-controls').style.display='flex';
  document.getElementById('graph-controls').style.display='none';
  document.getElementById('time-controls').style.display='none';
}
function showGraph(){ btnGraph.classList.add('active'); btnList.classList.remove('active');
  document.getElementById('view-graph').classList.add('active');
  document.getElementById('view-list').classList.remove('active');
  document.getElementById('graph-controls').style.display='flex';
  document.getElementById('time-controls').style.display='flex';
  document.getElementById('list-controls').style.display='none';
}
btnList.addEventListener('click',showList);
btnGraph.addEventListener('click',showGraph);

/* ---------- CSV ingest (file, drop, or HARDCODED URL) ---------- */
const HARDCODED = "s5_ok_2025-08-25_15-06-23.csv"; // <- change if you upload a new file name

const fileInput=document.getElementById('file'); const drop=document.getElementById('drop');
drop.addEventListener('dragover',e=>{e.preventDefault();drop.style.borderColor='var(--accent)';});
drop.addEventListener('dragleave',()=>drop.style.borderColor='var(--line)'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.style.borderColor='var(--line)';const f=e.dataTransfer.files?.[0];if(f)loadFile(f);});
fileInput.addEventListener('change',e=>{const f=e.target.files[0];if(f)loadFile(f);});

async function loadFile(file){
  const text = await file.text();
  parseAndHandle(text);
}
async function loadUrl(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  const text = await res.text();
  parseAndHandle(text);
}
function parseAndHandle(csvText){
  const out = Papa.parse(csvText, {header:true, skipEmptyLines:true, transformHeader:(h)=>(h||"").trim()});
  if(out.errors && out.errors.length){ console.warn(out.errors); }
  handleData(out.meta.fields, out.data);
}

/* ---------- data prep ---------- */
let CURRENT=null;
function pickCol(cols,...cands){
  const lc={}; cols.forEach(c=>lc[(c||'').toLowerCase()]=c);
  for(const c of cands){ if(lc[c?.toLowerCase()]) return lc[c.toLowerCase()]; }
  const cmp={}; cols.forEach(c=>cmp[(c||'').toLowerCase().replace(/\s+/g,'')]=c);
  for(const c of cands){ const k=(c||'').toLowerCase().replace(/\s+/g,''); if(cmp[k]) return cmp[k]; }
  return null;
}
const parseYear=s=>{ if(!s) return null; const m=String(s).match(/(\d{4})/); return m?+m[1]:null; };

function handleData(headers, rows){
  const col_parent=pickCol(headers,"Parent Entity Name");
  const col_child =pickCol(headers,"Child Entity","Issuer Name");
  const col_date  =pickCol(headers,"Filing Date","signatureDate","Date");
  const col_juris =pickCol(headers,"Jurisdiction");
  if(!col_parent||!col_child){ alert("Missing headers. Need 'Parent Entity Name' and 'Child Entity' (or 'Issuer Name')."); return; }

  const edgeYears=new Map(), parentsSet=new Set(), childrenSet=new Set(), filingsPerYear=new Map();

  for(const r of rows){
    const p=(r[col_parent]||"").trim(), c=(r[col_child]||"").trim(); if(!p||!c) continue;
    const y=parseYear(r[col_date]); if(y!=null) filingsPerYear.set(y,(filingsPerYear.get(y)||0)+1);
    const key="P|"+p+"||C|"+c;
    const rec=edgeYears.get(key)||{parent:p,child:c,years:[],juris:[]};
    if(y!=null) rec.years.push(y);
    const j=(r[col_juris]||"").trim(); if(j) rec.juris.push(j);
    edgeYears.set(key,rec); parentsSet.add(p); childrenSet.add(c);
  }

  const years=Array.from(filingsPerYear.keys()).sort((a,b)=>a-b);
  const minYear=years.length?years[0]:2000, maxYear=years.length?years[years.length-1]:new Date().getFullYear();

  CURRENT={edgeYears,parentsSet,childrenSet,years,minYear,maxYear,col_juris:!!col_juris};

  // Build list view
  const byParent=new Map();
  for(const r of rows){
    const p=(r[col_parent]||"").trim(), c=(r[col_child]||"").trim(); if(!p||!c) continue;
    if(!byParent.has(p)) byParent.set(p,[]);
    byParent.get(p).push({child:c,date:(r[col_date]||"").trim(),juris:(r[col_juris]||"").trim()});
  }
  const groups=Array.from(byParent.entries()).map(([parent,children])=>({
    parent,count:children.length,
    children:children.sort((a,b)=>(a.date<b.date?1:a.date>b.date?-1:a.child.localeCompare(b.child)))
  })).sort((a,b)=>b.count-a.count||a.parent.localeCompare(b.parent));

  document.getElementById('view-list').innerHTML =
    groups.map(g=>`<details class="card"><summary><span class="parent-name">${escapeHtml(g.parent)}</span> <span class="badge">${g.count}</span></summary>
      <div class="inner"><table><thead><tr><th>Child Entity</th><th>Filing Date</th><th>Jurisdiction</th></tr></thead>
        <tbody>${g.children.map(r=>`<tr><td>${escapeHtml(r.child)}</td><td>${escapeHtml(r.date)}</td><td>${escapeHtml(r.juris)}</td></tr>`).join('')}</tbody>
      </table></div></details>`).join('');

  // Fill focus dropdown
  const sel=document.getElementById('parent-select');
  sel.innerHTML = `<option value="">— choose parent —</option>` + Array.from(parentsSet).sort().map(p=>`<option>${escapeHtml(p)}</option>`).join('');

  // Time controls
  const yrFrom=document.getElementById('year-from'), yrTo=document.getElementById('year-to');
  yrFrom.min=minYear; yrFrom.max=maxYear; yrFrom.value=minYear;
  yrTo.min=minYear;   yrTo.max=maxYear;   yrTo.value=maxYear;
  updateRangeLabel(); drawHistogram(filingsPerYear,minYear,maxYear);

  if(window.__graph_reload) window.__graph_reload();
}

/* ---------- list helpers ---------- */
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
document.getElementById('expand').addEventListener('click',()=>{document.querySelectorAll('#view-list details').forEach(d=>d.open=true);});
document.getElementById('collapse').addEventListener('click',()=>{document.querySelectorAll('#view-list details').forEach(d=>d.open=false);});
document.getElementById('q').addEventListener('input',e=>{
  const t=(e.target.value||'').trim().toUpperCase();
  document.querySelectorAll('#view-list .card').forEach(card=>{
    const name=(card.querySelector('.parent-name')?.textContent||'').toUpperCase();
    card.classList.toggle('hidden', t && !name.includes(t));
  });
});

/* ---------- histogram drawing ---------- */
function drawHistogram(counts,minYear,maxYear){
  const cvs=document.getElementById('hist'),ctx=cvs.getContext('2d');
  const w=cvs.width=260,h=cvs.height=48; ctx.clearRect(0,0,w,h);
  const years=d3.range(minYear,maxYear+1); const maxV=d3.max(years.map(y=>counts.get(y)||0))||1; const barW=Math.max(1,Math.floor(w/years.length));
  ctx.fillStyle="#eee"; ctx.fillRect(0,0,w,h); ctx.fillStyle="#bbb";
  years.forEach((y,i)=>{ const v=(counts.get(y)||0); const bh=Math.round(v/maxV*(h-6)); ctx.fillRect(i*barW,h-bh,barW-1,bh); });
}

/* ---------- Graph (same as before, with “Apply time filter” default OFF) ---------- */
(function(){
  const canvas=document.getElementById('graph'), ctx=canvas.getContext('2d',{alpha:false});
  const tip=document.getElementById('tip'); const measure=document.createElement('canvas').getContext('2d'); const baseFont='12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'; measure.font=baseFont;

  let nodes=[],links=[],mode='overview',scale=1,tx=0,ty=0,dragging=null,panning=false,dragOffset=[0,0],panStart=[0,0],panOrig=[0,0],hover=null,pinned=new Set();

  const INCLUDE_UNDATED=true;
  const getCss=(v,def)=>getComputedStyle(document.documentElement).getPropertyValue(v).trim()||def;
  const parentCol=()=>getCss('--parent','#D04A02'), childCol=()=>getCss('--child','#00A3A1'), linkCol=()=>getCss('--link','#C8C4BE');

  function resize(){ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
  window.addEventListener('resize',()=>{resize();layout();}); resize();

  /* controls */
  const selParent=document.getElementById('parent-select');
  const countTop=document.getElementById('net-count');
  const layoutSel=document.getElementById('net-layout');
  const spacingInp=document.getElementById('net-spacing');
  const parentMax=document.getElementById('parent-size');
  const minDegInp=document.getElementById('min-degree');
  const maxLabels=document.getElementById('max-labels');
  const colorBySel=document.getElementById('color-by');
  const yearFrom=document.getElementById('year-from'), yearTo=document.getElementById('year-to'), timeOn=document.getElementById('time-on');
  const rangeLbl=document.getElementById('yr-range'); function updateRangeLabel(){rangeLbl.textContent=`${yearFrom.value} – ${yearTo.value}`;} window.updateRangeLabel=updateRangeLabel;

  function updateActiveStats(edgeList){const parents=new Set(edgeList.map(e=>e.p));document.getElementById('stat-parents').textContent=parents.size;document.getElementById('stat-links').textContent=edgeList.length;}

  function buildActiveGraph(){
    if(!window.CURRENT) return;
    const eY=window.CURRENT.edgeYears, Y0=+yearFrom.value, Y1=+yearTo.value;
    const useTime = !!timeOn.checked && window.CURRENT.years && window.CURRENT.years.length>0;

    const edges=[], parentDeg=new Map(), childDeg=new Map(), childJurCount=new Map();

    for(const rec of eY.values()){
      let inWindow=true, w=1;
      if(useTime){
        if(rec.years && rec.years.length){
          const yearsIn=rec.years.filter(y=>y>=Y0 && y<=Y1);
          inWindow = yearsIn.length>0;
          w=Math.max(1, yearsIn.length);
        }else{ inWindow=INCLUDE_UNDATED; w=1; }
      }
      if(!inWindow) continue;
      edges.push({p:rec.parent,c:rec.child,w, jurisList:rec.juris});
      parentDeg.set(rec.parent,(parentDeg.get(rec.parent)||0)+1);
      childDeg.set(rec.child,(childDeg.get(rec.child)||0)+1);
      if(rec.juris && rec.juris.length){
        const m=childJurCount.get(rec.child)||new Map(); rec.juris.forEach(j=>m.set(j,(m.get(j)||0)+1)); childJurCount.set(rec.child,m);
      }
    }
    updateActiveStats(edges);

    const minD=+minDegInp.value;
    const keepParents=new Set([...parentDeg].filter(([,d])=>d>=minD).map(([k])=>k));
    const keepChildren=new Set([...childDeg].filter(([,d])=>d>=minD).map(([k])=>k));

    const parents=[...keepParents].map(p=>({id:"P|"+p,label:p,group:"parent",degree:parentDeg.get(p)||0}));
    const children=[...keepChildren].map(c=>{
      const jurMap=childJurCount.get(c); let best=null,bestN=-1;
      if(jurMap) for(const [j,n] of jurMap) if(n>bestN){best=j;bestN=n;}
      return {id:"C|"+c,label:c,group:"child",degree:childDeg.get(c)||0,jur:(best||null)};
    });

    const maxR=+parentMax.value||28, minR=6;
    const degs=parents.map(p=>p.degree); const minC=degs.length?Math.min(...degs):0, maxC=degs.length?Math.max(...degs):1;
    const sizeFn = (maxC===minC)?(()=> (minR+maxR)/2):((c)=> minR + ((c-minC)/(maxC-minC))*(maxR-minR));
    parents.forEach(p=>p.size=sizeFn(p.degree)); children.forEach(c=>c.size=5);

    const linkObjs=edges.filter(e=>keepParents.has(e.p)&&keepChildren.has(e.c))
                        .map(e=>({source:"P|"+e.p,target:"C|"+e.c,w:e.w}));

    const useJur=(colorBySel.value==='jurisdiction');
    const PAL=d3.schemeTableau10.concat(["#A569BD","#F5B041","#16A085","#5D6D7E","#CA6F1E","#8E44AD"]);
    let jurDomain=[]; if(useJur){ jurDomain=[...new Set(children.map(n=>n.jur).filter(Boolean))].slice(0,PAL.length-1); }
    const jurColor=new Map(jurDomain.map((j,i)=>[j,PAL[i]])); const otherCol=PAL[PAL.length-1];

    const nodeMap=new Map([...parents,...children].map(n=>[n.id,n]));
    nodes=[...nodeMap.values()];
    links=linkObjs.map(l=>({source:nodeMap.get(l.source), target:nodeMap.get(l.target), w:l.w}));

    for(const n of nodes){
      if(n.group==='child') n.color = useJur ? (n.jur && jurColor.get(n.jur)?jurColor.get(n.jur):otherCol) : childCol();
      else n.color=parentCol();
    }

    const key=document.getElementById('jur-key'); key.innerHTML='';
    if(useJur){
      for(const j of jurDomain){ const el=document.createElement('div'); el.className='key-item'; el.innerHTML=`<span class="key-box" style="background:${jurColor.get(j)}"></span>${escapeHtml(j)}`; key.appendChild(el); }
      if(children.some(n=>!n.jur || !jurColor.get(n.jur))){ const el=document.createElement('div'); el.className='key-item'; el.innerHTML=`<span class="key-box" style="background:${otherCol}"></span>Other`; key.appendChild(el); }
    }
  }

  function buildOverview(){ buildActiveGraph(); layoutOverview(); }
  function buildFocus(){
    buildActiveGraph();
    const p=selParent.value; if(!p){layoutOverview();return;}
    const parent=nodes.find(n=>n.group==='parent' && n.label===p); if(!parent){layoutOverview();return;}
    const kids=links.filter(e=>e.source===parent).map(e=>e.target);
    nodes=[parent,...kids]; links=links.filter(e=>e.source===parent); layoutFocusRing();
  }
  function buildNetwork(){
    buildActiveGraph();
    const N=+countTop.value;
    const parents=nodes.filter(n=>n.group==='parent').sort((a,b)=>b.degree-a.degree).slice(0,N);
    const keepP=new Set(parents.map(p=>p.id)), childSet=new Set();
    links=links.filter(e=>{ if(keepP.has(e.source.id)){ childSet.add(e.target.id); return true; } return false; });
    nodes=[...parents, ...nodes.filter(n=>n.group==='child' && childSet.has(n.id))];
    layoutAnchored();
  }

  function layout(){ if(mode==='overview')layoutOverview(); else if(mode==='focus')layoutFocusRing(); else layoutAnchored(); }
  function layoutOverview(){
    const cw=canvas.width,ch=canvas.height,pad=60,n=nodes.length; if(!n) return;
    const cols=Math.ceil(Math.sqrt(n)),rows=Math.ceil(n/cols),cellW=(cw-pad*2)/cols,cellH=(ch-pad*2)/rows;
    nodes.forEach((node,i)=>{ if(pinned.has(node.id)) return; const c=i%cols,r=Math.floor(i/cols); node.x=pad+c*cellW+cellW/2; node.y=pad+r*cellH+cellH/2; });
  }
  function layoutFocusRing(){
    const cw=canvas.width,ch=canvas.height,cx=cw/2,cy=ch/2; const parent=nodes.find(n=>n.group==='parent'); if(!parent) return;
    if(!pinned.has(parent.id)){ parent.x=cx; parent.y=cy; }
    const kids=nodes.filter(n=>n.group==='child'), TWO_PI=Math.PI*2, startR=140, ringGap=95, minSep=12;
    function labelW(n){return Math.min(220,measure.measureText(n.label||'').width);}
    let ring=0,used=0,R=startR,start=Math.random()*TWO_PI;
    for(const k of kids.slice().sort((a,b)=>(b.size||7)-(a.size||7))){
      let span=Math.max(2*(k.size||7),labelW(k)+minSep), ang=span/R;
      while(used+ang>TWO_PI){ ring++; R=startR+ring*ringGap; used=0; ang=span/R; }
      if(!pinned.has(k.id)){ const t=start+used+ang/2; k.x=parent.x+R*Math.cos(t); k.y=parent.y+R*Math.sin(t); }
      used+=ang;
    }
  }
  function layoutAnchored(){
    const cw=canvas.width,ch=canvas.height, spacing=+spacingInp.value, P=nodes.filter(n=>n.group==='parent').length;
    const anchors=new Map(), TWO_PI=Math.PI*2, baseR=300, R=baseR*spacing;
    const parents=nodes.filter(n=>n.group==='parent').sort((a,b)=>b.degree-a.degree);
    const layoutType=layoutSel.value;
    if(layoutType==='grid'){
      const cols=Math.ceil(Math.sqrt(P)),rows=Math.ceil(P/cols),cell=180*spacing,x0=-(cols-1)*cell/2,y0=-(rows-1)*cell/2;
      parents.forEach((p,i)=>anchors.set(p.id,{x:x0+(i%cols)*cell,y:y0+Math.floor(i/cols)*cell}));
    }else if(layoutType==='radial'){
      parents.forEach((p,i)=>{ const t=(i/P)*TWO_PI, norm=P>1?(1-i/(P-1)):1, ring=R*(0.8+0.6*norm); anchors.set(p.id,{x:ring*Math.cos(t),y:ring*Math.sin(t)}); });
    }else{
      parents.forEach((p,i)=>{ const t=(i/P)*TWO_PI; anchors.set(p.id,{x:R*Math.cos(t),y:R*Math.sin(t)}); });
    }
    parents.forEach(p=>{ if(!pinned.has(p.id)){ p.x=cw/2+anchors.get(p.id).x; p.y=ch/2+anchors.get(p.id).y; } });
    const childrenByParent=d3.group(links,d=>d.source.id);
    for(const [pid,edges] of childrenByParent){
      const a=anchors.get(pid); if(!a) continue; const cx=cw/2+a.x, cy=ch/2+a.y; const r0=90; let t=0;
      for(const e of edges){ const c=e.target; if(pinned.has(c.id)) continue; const rr=r0+(Math.random()*45); c.x=cx+rr*Math.cos(t); c.y=cy+rr*Math.sin(t); t+=(Math.PI*2)/Math.max(8,edges.length); }
    }
  }

  /* interactions */
  function toGraph(sx,sy){ return [(sx-tx)/scale,(sy-ty)/scale]; }
  function pick(x,y){ for(let i=nodes.length-1;i>=0;i--){ const n=nodes[i],dx=x-n.x,dy=y-n.y,r=(n.size+6); if(dx*dx+dy*dy<=r*r) return n;} return null;}
  function showTip(n,sx,sy){ const lines=[(n.group==='parent'?'Parent':'Child')+': '+n.label]; if(n.degree!=null) lines.push('Degree: '+n.degree); if(n.jur) lines.push('Jurisdiction: '+n.jur); tip.innerHTML=lines.join('<br/>'); tip.style.left=(sx+12)+'px'; tip.style.top=(sy-10)+'px'; tip.style.display='block'; }
  function hideTip(){ tip.style.display='none'; }

  canvas.addEventListener('wheel',e=>{ const m=e.deltaY>0?0.9:1.1, before=toGraph(e.offsetX,e.offsetY); scale*=m; const after=toGraph(e.offsetX,e.offsetY); tx+=(after[0]-before[0])*scale; ty+=(after[1]-before[1])*scale; e.preventDefault(); },{passive:false});
  canvas.addEventListener('mousedown',e=>{ const [gx,gy]=toGraph(e.offsetX,e.offsetY), hit=pick(gx,gy);
    if(hit){ dragging=hit; dragOffset=[gx-hit.x,gy-hit.y]; showTip(hit,e.offsetX,e.offsetY); if(mode==='overview'&&hit.group==='parent'){ document.getElementById('parent-select').value=hit.label; buildFocus(); mode='focus'; fitScreen(); } }
    else { panning=true; panStart=[e.offsetX,e.offsetY]; panOrig=[tx,ty]; hideTip(); }
  });
  window.addEventListener('mousemove',e=>{
    if(dragging){ const [gx,gy]=toGraph(e.offsetX,e.offsetY); if(!pinned.has(dragging.id)){ dragging.x=gx-dragOffset[0]; dragging.y=gy-dragOffset[1]; } showTip(dragging,e.offsetX,e.offsetY); }
    else if(panning){ tx=panOrig[0]+(e.offsetX-panStart[0]); ty=panOrig[1]+(e.offsetY-panStart[1]); }
    else { const [gx,gy]=toGraph(e.offsetX,e.offsetY); hover=pick(gx,gy); if(!hover) hideTip(); else showTip(hover,e.offsetX,e.offsetY); }
  });
  window.addEventListener('mouseup',()=>{ dragging=null; panning=false; });
  canvas.addEventListener('dblclick',e=>{ const [gx,gy]=toGraph(e.offsetX,e.offsetY), hit=pick(gx,gy); if(!hit) return; if(pinned.has(hit.id)) pinned.delete(hit.id); else pinned.add(hit.id); });

  document.getElementById('fit').addEventListener('click',fitScreen);
  document.getElementById('mode-overview').addEventListener('click',()=>{mode='overview';buildOverview();fitScreen();});
  document.getElementById('mode-focus').addEventListener('click',()=>{mode='focus';buildFocus();fitScreen();});
  document.getElementById('mode-network').addEventListener('click',()=>{mode='network';buildNetwork();fitScreen();});
  document.getElementById('rerun').addEventListener('click',()=>{ if(mode==='overview')buildOverview(); else if(mode==='focus')buildFocus(); else buildNetwork(); fitScreen(); });

  [document.getElementById('parent-select'),document.getElementById('net-count'),document.getElementById('net-layout'),
   document.getElementById('net-spacing'),document.getElementById('parent-size'),
   document.getElementById('min-degree'),document.getElementById('max-labels'),
   document.getElementById('color-by'),document.getElementById('time-on')
  ].forEach(el=>{
    el.addEventListener('input',()=>{ if(!window.CURRENT) return; if(mode==='overview')buildOverview(); else if(mode==='focus')buildFocus(); else buildNetwork(); fitScreen(false); });
  });
  [document.getElementById('year-from'),document.getElementById('year-to')].forEach(el=>{
    el.addEventListener('input',()=>{ const a=document.getElementById('year-from'), b=document.getElementById('year-to'); if(+a.value>+b.value) a.value=b.value; updateRangeLabel(); if(mode==='overview')buildOverview(); else if(mode==='focus')buildFocus(); else buildNetwork(); fitScreen(false); });
  });

  document.getElementById('play').addEventListener('click',()=>{
    const on=document.getElementById('time-on'); if(!on.checked) on.checked=true;
    const min=+document.getElementById('year-from').min,max=+document.getElementById('year-to').max;
    document.getElementById('year-from').value=min; document.getElementById('year-to').value=min; updateRangeLabel();
    let h=setInterval(()=>{ let y=+document.getElementById('year-to').value+1; if(y>max){clearInterval(h);return;} document.getElementById('year-to').value=y; if(mode==='overview')buildOverview(); else if(mode==='focus')buildFocus(); else buildNetwork(); },400);
  });

  document.getElementById('export').addEventListener('click',()=>{ const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='relationship-map.png'; a.click(); });

  window.__graph_reload=()=>{ mode='overview'; pinned.clear(); buildOverview(); fitScreen(); requestAnimationFrame(draw); };

  function fitScreen(){
    if(!nodes.length) return;
    const cw=canvas.width,ch=canvas.height,cx=cw/2,cy=ch/2;
    const minx=Math.min(...nodes.map(n=>n.x)), maxx=Math.max(...nodes.map(n=>n.x));
    const miny=Math.min(...nodes.map(n=>n.y)), maxy=Math.max(...nodes.map(n=>n.y));
    const w=Math.max(1,maxx-minx), h=Math.max(1,maxy-miny);
    const s=0.9*Math.min(cw/w,ch/h); scale=isFinite(s)?Math.min(Math.max(s,0.1),5):1;
    tx=cx-((minx+maxx)/2)*scale; ty=cy-((miny+maxy)/2)*scale;
  }

  function draw(){
    ctx.fillStyle=getCss('--card','#FFF'); ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(tx,ty); ctx.scale(scale,scale);

    let neighborIds=null;
    if(hover){ neighborIds=new Set([hover.id]); for(const e of links){ const s=e.source.id,t=e.target.id; if(s===hover.id) neighborIds.add(t); if(t===hover.id) neighborIds.add(s); } }

    const drawLinks=(filter,alpha)=>{ ctx.globalAlpha=alpha; ctx.strokeStyle=linkCol();
      for(const e of links){ if(filter && !filter(e)) continue;
        const s=e.source,t=e.target,w=Math.max(0.6,Math.min(3.0,0.6+e.w*0.6)); ctx.lineWidth=Math.max(w/scale,0.2);
        const mx=(s.x*2+t.x)/3,my=(s.y*2+t.y)/3; ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.quadraticCurveTo(mx,my,t.x,t.y); ctx.stroke();
      } ctx.globalAlpha=1; };
    if(hover){ drawLinks(null,0.08); drawLinks(e=> (e.source.id===hover.id || e.target.id===hover.id),1); } else drawLinks(null,1);

    for(const n of nodes){
      const r=Math.max(n.size||7,2/scale); const dim = neighborIds ? !neighborIds.has(n.id) : false;
      ctx.globalAlpha = dim ? 0.25 : 1;
      ctx.beginPath(); ctx.fillStyle=n.color || (n.group==='parent'?parentCol():childCol());
      ctx.arc(n.x,n.y,r,0,Math.PI*2); ctx.fill();
      if(n.group==='parent'&&(n.degree||0)>0){ ctx.globalAlpha=dim?0.15:0.25; ctx.beginPath(); ctx.strokeStyle=n.color; ctx.lineWidth=Math.max((1+n.degree*0.1)/scale,0.5/scale); ctx.arc(n.x,n.y,r+4/scale,0,Math.PI*2); ctx.stroke(); }
      ctx.globalAlpha=1;
    }
    ctx.restore();

    const K=+document.getElementById('max-labels').value;
    if(K>0){
      const ranked=nodes.slice().sort((a,b)=>{ const gp=(a.group==='parent')-(b.group==='parent'); if(gp) return -gp; const d=(b.degree||0)-(a.degree||0); if(d) return d; return a.label.localeCompare(b.label); }).slice(0,K);
      const placed=[]; ctx.save(); ctx.font=baseFont; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#333';
      for(const n of ranked){ const r=Math.max(n.size||7,2/scale), sx=n.x*scale+tx, sy=(n.y+r+4)*scale+ty, w=measure.measureText(n.label||'').width*scale, h=14*scale;
        const x0=sx-w/2,y0=sy,x1=x0+w,y1=y0+h; let ok=true; for(const b of placed){ if(x0<b.x1+2 && x1>b.x0-2 && y0<b.y1+2 && y1>b.y0-2){ ok=false; break; } }
        if(ok){ placed.push({x1,y1,x0,y0}); ctx.fillText(n.label,sx,sy); }
      }
      ctx.restore();
    }
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* ---------- init: auto-load hardcoded CSV ---------- */
(async function init(){
  try{
    await loadUrl(HARDCODED);            // auto-load from the repo
    showGraph();                         // default to Graph view
  }catch(err){
    console.warn("Autoload failed:", err);
    // Page still works; user can choose/drop a file.
  }
})();
</script>
</body>
</html>
